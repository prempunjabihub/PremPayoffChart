<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Payoff Diagram</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
            color: #2d3748;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            max-width: 900px;
            width: 100%;
        }

        canvas {
            background-color: #ffffff;
            border-radius: 0.5rem;
            position: relative;
        }

        .input-group input, .input-group select {
            background-color: #edf2f7;
            border: 1px solid #cbd5e0;
            color: #2d3748;
            padding: 0.5rem;
            border-radius: 0.25rem;
            width: 100%;
        }
        
        .input-group {
            margin-bottom: 1rem;
        }

        .title {
            border-bottom: 2px solid #a0aec0;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        #tooltip {
            position: absolute;
            background-color: #1a202c;
            color: #ffffff;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            pointer-events: none;
            z-index: 10;
            white-space: nowrap;
            display: none;
        }

        .add-leg-btn {
            background-color: #4299e1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            display: block;
            width: 100%;
            text-align: center;
            transition: background-color 0.2s ease;
        }
        
        .add-leg-btn:hover {
            background-color: #3182ce;
        }
        
        .leg-container {
            border: 1px dashed #cbd5e0;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .fetch-btn {
            background-color: #48bb78;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            display: block;
            width: 100%;
            text-align: center;
            margin-bottom: 1rem;
            transition: background-color 0.2s ease;
        }

        .fetch-btn:hover {
            background-color: #38a169;
        }
        .input-label {
            display: block;
            font-size: 0.875rem;
            color: #4a5568;
            margin-top: 0.5rem;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center p-4 min-h-screen">

    <div class="container mx-auto p-8 rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold mb-6 text-center title">Options Payoff Diagram</h1>

        <!-- Input Section -->
        <div>
            <h2 class="text-xl font-semibold mb-4">Strategy Parameters</h2>
            <div class="input-group">
                <label for="spotPrice">Current Spot Price:</label>
                <input type="number" id="spotPrice" value="24000">
            </div>

            <button id="fetchPriceBtn" class="fetch-btn">Shuffle Price</button>

            <div id="legsContainer">
                <!-- Initial Leg 1 -->
                <div class="leg-container">
                    <h3 class="text-lg font-medium mt-4 mb-2 text-center">Leg 1</h3>
                    <div class="input-group">
                        <div class="flex items-end gap-2 mt-2">
                            <div class="flex flex-col items-center w-1/3">
                                <label for="leg1-strike">Strike Price:</label>
                                <input type="number" class="leg-strike w-full" id="leg1-strike" value="24000" placeholder="Strike Price">
                            </div>
                            <div class="flex flex-col items-center w-1/3">
                                <label for="leg1-lots">Number of Lots:</label>
                                <input type="number" class="leg-lots w-full" id="leg1-lots" value="1" placeholder="Lots">
                            </div>
                            <div class="flex flex-col items-center w-1/3">
                                <label for="leg1-lot-size">Lot Size:</label>
                                <input type="number" class="leg-lot-size w-full" id="leg1-lot-size" value="75" placeholder="Lot Size">
                            </div>
                        </div>
                        <div class="flex items-end gap-2 mt-2">
                            <div class="flex flex-col items-center w-1/3">
                                <select class="leg-type w-full">
                                    <option value="call" selected>Call</option>
                                    <option value="put">Put</option>
                                </select>
                                <span class="input-label">Option Type</span>
                            </div>
                            <div class="flex flex-col items-center w-1/3">
                                <select class="leg-action w-full">
                                    <option value="buy" selected>Buy</option>
                                    <option value="sell">Sell</option>
                                </select>
                                <span class="input-label">Buy / Sell</span>
                            </div>
                            <div class="flex flex-col items-center w-1/3">
                                <input type="number" class="leg-premium w-full" value="110" placeholder="Premium">
                                <span class="input-label">Premium</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Dynamic legs will be added here -->
            </div>

            <button id="addLegBtn" class="add-leg-btn">+ Add More Legs</button>
        </div>
        
        <!-- Canvas for the payoff diagram and tooltip container -->
        <div class="relative w-full h-96 mt-6">
            <canvas id="payoffCanvas" class="w-full h-full border-2 border-gray-300 rounded-lg"></canvas>
            <div id="tooltip" class="absolute hidden"></div>
        </div>
    </div>

    <script>
        window.onload = function() {
            const canvas = document.getElementById('payoffCanvas');
            const ctx = canvas.getContext('2d');
            const legsContainer = document.getElementById('legsContainer');
            const addLegBtn = document.getElementById('addLegBtn');
            const fetchPriceBtn = document.getElementById('fetchPriceBtn');
            const tooltip = document.getElementById('tooltip');
            let legCounter = 1;
            
            let hoverPrice = null;

            function resizeCanvas() {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                drawPayoffDiagram();
            }
            
            function fetchNiftyPrice() {
                // This function simulates fetching a live price.
                // Due to the lack of a free, public API for real-time stock data,
                // we are generating a random price to demonstrate the functionality.
                const currentPrice = parseFloat(document.getElementById('spotPrice').value);
                const newPrice = currentPrice + (Math.random() * 50 - 25);
                document.getElementById('spotPrice').value = newPrice.toFixed(2);
                drawPayoffDiagram();
            }

            function calculateLegPL(stockPrice, action, type, strike, premium, numberOfLots, lotSize) {
                let pl = 0;
                if (type === 'call') {
                    if (action === 'buy') {
                        pl = Math.max(0, stockPrice - strike) - premium;
                    } else { // sell
                        pl = Math.min(0, strike - stockPrice) + premium;
                    }
                } else { // put
                    if (action === 'buy') {
                        pl = Math.max(0, strike - stockPrice) - premium;
                    } else { // sell
                        pl = Math.min(0, stockPrice - strike) + premium;
                    }
                }
                return pl * numberOfLots * lotSize;
            }

            // Function to draw the payoff diagram
            function drawPayoffDiagram() {
                // Clear the canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Get values from inputs
                const spotPrice = parseFloat(document.getElementById('spotPrice').value);
                const legs = Array.from(legsContainer.children).map(legDiv => {
                    const strike = parseFloat(legDiv.querySelector('.leg-strike').value);
                    const type = legDiv.querySelector('.leg-type').value;
                    const action = legDiv.querySelector('.leg-action').value;
                    const premium = parseFloat(legDiv.querySelector('.leg-premium').value);
                    const numberOfLots = parseFloat(legDiv.querySelector('.leg-lots').value);
                    const lotSize = parseFloat(legDiv.querySelector('.leg-lot-size').value);
                    return { strike, type, action, premium, numberOfLots, lotSize };
                });
                
                // Determine price range for the graph
                const range = 500;
                const minPrice = spotPrice - range;
                const maxPrice = spotPrice + range;
                const priceStep = 1;

                // Calculate P&L points
                const points = [];
                let maxProfit = -Infinity;
                let maxLoss = Infinity;
                let breakevens = [];

                for (let price = minPrice; price <= maxPrice; price += priceStep) {
                    let pl = 0;
                    legs.forEach(leg => {
                        if (!isNaN(leg.strike) && !isNaN(leg.premium) && !isNaN(leg.numberOfLots) && !isNaN(leg.lotSize)) {
                            pl += calculateLegPL(price, leg.action, leg.type, leg.strike, leg.premium, leg.numberOfLots, leg.lotSize);
                        }
                    });
                    
                    points.push({ x: price, y: pl });
                    if (pl > maxProfit) maxProfit = pl;
                    if (pl < maxLoss) maxLoss = pl;
                    
                    if (pl >= 0 && points.length > 1 && points[points.length-2].y < 0) {
                        const p1 = points[points.length-2];
                        const p2 = points[points.length-1];
                        const slope = (p2.y - p1.y) / (p2.x - p1.x);
                        const breakeven = p1.x - (p1.y / slope);
                        breakevens.push(breakeven);
                    }
                }

                // Scale for drawing
                const padding = 20;
                const canvasWidth = canvas.width - padding * 2;
                const canvasHeight = canvas.height - padding * 2;

                const allY = points.map(p => p.y);
                const minY = Math.min(...allY);
                const maxY = Math.max(...allY);
                const chartMinY = minY - (maxY - minY) * 0.1;
                const chartMaxY = maxY + (maxY - minY) * 0.1;

                const xScale = canvasWidth / (maxPrice - minPrice);
                const yScale = canvasHeight / (chartMaxY - chartMinY);

                const originX = padding;
                const originY = padding + canvasHeight;

                // Draw shaded areas
                ctx.save();
                const yZero = originY - (0 - chartMinY) * yScale;
                ctx.beginPath();
                ctx.moveTo(originX, yZero);
                points.forEach(point => {
                    const x = originX + (point.x - minPrice) * xScale;
                    const y = originY - (point.y - chartMinY) * yScale;
                    ctx.lineTo(x, y);
                });
                ctx.lineTo(originX + canvasWidth, yZero);
                ctx.closePath();

                ctx.clip();
                ctx.fillStyle = 'rgba(76, 175, 80, 0.3)';
                ctx.fillRect(originX, originY - (Math.max(0, chartMaxY) - chartMinY) * yScale, canvasWidth, (Math.max(0, chartMaxY) - chartMinY) * yScale);
                ctx.fillStyle = 'rgba(244, 67, 54, 0.3)';
                ctx.fillRect(originX, yZero, canvasWidth, (Math.max(0, chartMinY) - chartMinY) * yScale);
                ctx.restore();

                // Draw axes
                ctx.save();
                ctx.strokeStyle = '#a0aec0';
                ctx.lineWidth = 2;

                ctx.beginPath();
                ctx.moveTo(originX, yZero);
                ctx.lineTo(originX + canvasWidth, yZero);
                ctx.stroke();

                const xSpot = originX + (spotPrice - minPrice) * xScale;
                ctx.beginPath();
                ctx.setLineDash([5, 5]);
                ctx.moveTo(xSpot, originY);
                ctx.lineTo(xSpot, originY - canvasHeight);
                ctx.stroke();
                ctx.setLineDash([]);

                ctx.strokeStyle = '#48bb78';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                points.forEach((point, index) => {
                    const x = originX + (point.x - minPrice) * xScale;
                    const y = originY - (point.y - chartMinY) * yScale;
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();

                // Draw labels and markers
                ctx.fillStyle = '#2d3748';
                ctx.font = '12px Inter';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                const tickInterval = 50; 
                const startPrice = Math.floor(minPrice / tickInterval) * tickInterval;
                const endPrice = Math.ceil(maxPrice / tickInterval) * tickInterval;

                for (let price = startPrice; price <= endPrice; price += tickInterval) {
                    const x = originX + (price - minPrice) * xScale;
                    
                    ctx.beginPath();
                    ctx.moveTo(x, yZero);
                    ctx.lineTo(x, yZero + 5);
                    ctx.stroke();

                    ctx.fillText(price.toFixed(0), x, yZero + 15);
                }

                const yLabels = [chartMinY, 0, chartMaxY];
                yLabels.forEach(label => {
                    const y = originY - (label - chartMinY) * yScale;
                    ctx.fillText(label.toFixed(0), originX - 15, y);
                });

                ctx.fillText('Stock Price', originX + canvasWidth / 2, yZero + 35);
                ctx.save();
                ctx.translate(originX - 35, originY - canvasHeight / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.fillText('Profit/Loss', 0, 0);
                ctx.restore();

                ctx.fillText('Spot', xSpot, originY - canvasHeight - 10);

                if(hoverPrice !== null) {
                    const x = originX + (hoverPrice - minPrice) * xScale;
                    ctx.beginPath();
                    ctx.strokeStyle = '#4299e1'; // Blue color
                    ctx.lineWidth = 1;
                    ctx.setLineDash([5, 5]);
                    ctx.moveTo(x, yZero);
                    ctx.lineTo(x, originY - canvasHeight);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }

                ctx.restore();
            }

            function addLeg() {
                legCounter++;
                const newLegDiv = document.createElement('div');
                newLegDiv.classList.add('leg-container');
                newLegDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-medium mt-4 mb-2 flex-grow text-center">Leg ${legCounter}</h3>
                        <button class="remove-leg-btn text-2xl text-red-500 hover:text-red-700 font-bold leading-none">&times;</button>
                    </div>
                    <div class="input-group">
                        <div class="flex items-end gap-2 mt-2">
                            <div class="flex flex-col items-center w-1/3">
                                <label for="leg${legCounter}-strike">Strike Price:</label>
                                <input type="number" class="leg-strike w-full" id="leg${legCounter}-strike" placeholder="Strike Price" value="${document.getElementById('spotPrice').value}">
                            </div>
                            <div class="flex flex-col items-center w-1/3">
                                <label for="leg${legCounter}-lots">Number of Lots:</label>
                                <input type="number" class="leg-lots w-full" id="leg${legCounter}-lots" placeholder="Lots" value="1">
                            </div>
                            <div class="flex flex-col items-center w-1/3">
                                <label for="leg${legCounter}-lot-size">Lot Size:</label>
                                <input type="number" class="leg-lot-size w-full" id="leg${legCounter}-lot-size" placeholder="Lot Size" value="75">
                            </div>
                        </div>
                        <div class="flex items-end gap-2 mt-2">
                            <div class="flex flex-col items-center w-1/3">
                                <select class="leg-type w-full">
                                    <option value="call" selected>Call</option>
                                    <option value="put">Put</option>
                                </select>
                                <span class="input-label">Option Type</span>
                            </div>
                            <div class="flex flex-col items-center w-1/3">
                                <select class="leg-action w-full">
                                    <option value="buy" selected>Buy</option>
                                    <option value="sell">Sell</option>
                                </select>
                                <span class="input-label">Buy / Sell</span>
                            </div>
                            <div class="flex flex-col items-center w-1/3">
                                <input type="number" class="leg-premium w-full" placeholder="Premium" value="110">
                                <span class="input-label">Premium</span>
                            </div>
                        </div>
                    </div>
                `;
                legsContainer.appendChild(newLegDiv);
                
                // Add event listeners to the new inputs
                const newInputs = newLegDiv.querySelectorAll('input, select');
                newInputs.forEach(input => {
                    input.addEventListener('input', drawPayoffDiagram);
                });
                
                // Add event listener to the new remove button
                newLegDiv.querySelector('.remove-leg-btn').addEventListener('click', () => {
                    newLegDiv.remove();
                    reNumberLegs();
                    drawPayoffDiagram();
                });

                drawPayoffDiagram();
            }

            function reNumberLegs() {
                const legContainers = legsContainer.querySelectorAll('.leg-container');
                legContainers.forEach((container, index) => {
                    const h3 = container.querySelector('h3');
                    if (h3) {
                        h3.textContent = `Leg ${index + 1}`;
                    }
                });
                legCounter = legContainers.length;
            }

            addLegBtn.addEventListener('click', addLeg);
            fetchPriceBtn.addEventListener('click', fetchNiftyPrice);

            // Add interactivity to the canvas
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.offsetX;
                const y = e.offsetY;
                
                const padding = 20;
                const canvasWidth = canvas.width - padding * 2;
                const canvasHeight = canvas.height - padding * 2;
                const spotPrice = parseFloat(document.getElementById('spotPrice').value);
                const range = 500;
                const minPrice = spotPrice - range;
                const maxPrice = spotPrice + range;
                const xScale = canvasWidth / (maxPrice - minPrice);
                
                if (x >= padding && x <= canvas.width - padding && y >= padding && y <= canvas.height - padding) {
                    hoverPrice = minPrice + (x - padding) / xScale;

                    let pl = 0;
                    const legs = Array.from(legsContainer.children).map(legDiv => {
                        const strike = parseFloat(legDiv.querySelector('.leg-strike').value);
                        const type = legDiv.querySelector('.leg-type').value;
                        const action = legDiv.querySelector('.leg-action').value;
                        const premium = parseFloat(legDiv.querySelector('.leg-premium').value);
                        const numberOfLots = parseFloat(legDiv.querySelector('.leg-lots').value);
                        const lotSize = parseFloat(legDiv.querySelector('.leg-lot-size').value);
                        return { strike, type, action, premium, numberOfLots, lotSize };
                    });

                    legs.forEach(leg => {
                        if (!isNaN(leg.strike) && !isNaN(leg.premium) && !isNaN(leg.numberOfLots) && !isNaN(leg.lotSize)) {
                            pl += calculateLegPL(hoverPrice, leg.action, leg.type, leg.strike, leg.premium, leg.numberOfLots, leg.lotSize);
                        }
                    });

                    // Position the tooltip relative to the canvas container
                    const containerRect = canvas.parentElement.getBoundingClientRect();
                    tooltip.style.left = `${e.clientX - containerRect.left + 15}px`;
                    tooltip.style.top = `${e.clientY - containerRect.top - 30}px`;
                    
                    tooltip.textContent = `Price: ${hoverPrice.toFixed(2)} | P&L: ${pl.toFixed(2)}`;
                    tooltip.style.display = 'block';
                    drawPayoffDiagram();
                } else {
                    tooltip.style.display = 'none';
                    hoverPrice = null;
                    drawPayoffDiagram();
                }
            });

            canvas.addEventListener('mouseenter', () => {
                tooltip.style.display = 'block';
            });
            
            canvas.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
                hoverPrice = null;
                drawPayoffDiagram();
            });

            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // Initial draw for the first leg
            document.querySelectorAll('.leg-container input, .leg-container select').forEach(input => {
                input.addEventListener('input', drawPayoffDiagram);
            });
        };
    </script>
</body>
</html>
